<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-05-20 Thu 00:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Luca's nix configuration</title>
<meta name="author" content="Luca Cambiaghi" />
<meta name="generator" content="Org Mode" />
<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101260027);</script>
<script async src="//static.getclicky.com/js"></script>
<style type="text/css">
<!--/*--><![CDATA[/*><!--*/
*,
*::before,
*::after {
	box-sizing: border-box;
}

html {
	line-height: 1.35;
	-webkit-text-size-adjust: 100%;
}

body {
	margin: 0;
	font-family:
		system-ui,
		-apple-system,
		'Segoe UI',
		Roboto,
		Helvetica,
		Arial,
		sans-serif,
		'Apple Color Emoji',
		'Segoe UI Emoji';
}

hr {
	height: 0;
	color: inherit;
}

b,
strong {
	font-weight: bolder;
}

code,
kbd,
samp,
pre {
	font-family:
		ui-monospace,
		SFMono-Regular,
		Consolas,
		'Liberation Mono',
		Menlo,
		monospace;
	font-size: 1em;
}

small {
	font-size: 80%;
}

sub,
sup {
	font-size: 75%;
	line-height: 0;
	position: relative;
	vertical-align: baseline;
}

sub {
	bottom: -0.25em;
}

sup {
	top: -0.5em;
}

table {
	text-indent: 0;
	border-color: inherit;
}

summary {
	display: list-item;
}

:root {
  --bc-tb: #282e46;
  --bc-block: #a8a8a8;
  --clr: #ffffff;
  --clr-tb-hd: #e0e6f0;
  --clr-code: #e0e6f0;
  --bg: #100b17;
  --bg-code: #282e46;
  --bg-tb-hd: #282e46;
  --bg-block: #161129;
  --clr-link: #00bcff;
  --clr-title: #ffffff;
  --clr-todo: #79a8ff;
  --bg-todo: initial;
  --clr-done: #a8a8a8;
  --bg-done: initial;
  --ts-clr: #b6a0ff;
  --mg: 20px;
  --w-toc: 300px;
  --bg-keyword: initial;
  --clr-keyword: #b6a0ff;
  --bg-constant: initial;
  --clr-constant: #00bcff;
  --bg-comment: initial;
  --clr-comment: #a8a8a8;
  --bg-comment-delimiter: initial;
  --clr-comment-delimiter: initial;
  --bg-function: initial;
  --clr-function: #feacd0;
  --bg-variable: initial;
  --clr-variable: #00d3d0;
  --bg-preprocessor: initial;
  --clr-preprocessor: #ff9977;
  --bg-doc: initial;
  --clr-doc: #b0d6f5;
  --bg-builtin: initial;
  --clr-builtin: #f78fe7;
  --bg-string: initial;
  --clr-string: #79a8ff;
}

html {
  font-family: Sans;
}

body {
  background: #999;
  display: flex;
  flex-direction: column;
  align-items: center;
}

body[data-theme='light'] {
  background: var(--bg);
  color: var(--clr);
}

body[data-theme='dark'] {
  background: var(--bg);
  color: var(--clr);
  --bc-tb: #282e46;
  --bc-block: #a8a8a8;
  --clr: #ffffff;
  --clr-code: #e0e6f0;
  --clr-tb-hd: #e0e6f0;
  --bg: #100b17;
  --bg-tb-hd: #282e46;
  --bg-code: #282e46;
  --bg-block: #161129;
  --clr-link: #00bcff;
  --clr-title: #ffffff;
  --clr-todo: #79a8ff;
  --bg-todo: initial;
  --clr-done: #a8a8a8;
  --bg-done: initial;
  --ts-clr: #b6a0ff;
  --mg: 20px;
  --w-toc: 300px;
  --bg-keyword: initial;
  --clr-keyword: #b6a0ff;
  --bg-constant: initial;
  --clr-constant: #00bcff;
  --bg-comment: initial;
  --clr-comment: #a8a8a8;
  --bg-comment-delimiter: initial;
  --clr-comment-delimiter: initial;
  --bg-function: initial;
  --clr-function: #feacd0;
  --bg-variable: initial;
  --clr-variable: #00d3d0;
  --bg-preprocessor: initial;
  --clr-preprocessor: #ff9977;
  --bg-doc: initial;
  --clr-doc: #b0d6f5;
  --bg-builtin: initial;
  --clr-builtin: #f78fe7;
  --bg-string: initial;
  --clr-string: #79a8ff;
}


@media only screen and (max-width: 768px) {
  #content {
    width: 100%;
    padding-left: 10px;
    padding-right: 10px;
  }
}

@media only screen and (min-width: 768px) {
  #content {
    width: 768px;
  }
}

@media only screen and (min-width: 1024px) {
  body {
    align-items: flex-end;
  }
  #content {
    width: calc(100vw - var(--w-toc) - var(--mg) * 3);
    margin-right: var(--mg);
  }
}

h1 {
  color: var(--clr-title);
  text-align: center;
}
h2, h3, h4, h5, h6, h7 {
  font-family: Sans Serif;
}
h2 {
  line-height: 2.5em;
}
h2::before {
  content: "◉ ";
}
h3::before {
  content: "✸ ";
}
h4::before {
  content: "▷ ";
}

code {
  color: var(--clr-code);
  background: var(--bg-code);
  border-radius: 2px;
  padding-left: 5px;
  padding-right: 5px;
}

pre {
  padding: 20px;
  border: 1px solid var(--bc-block);
  background: var(--bg-block);
  font-size: 0.9rem;
  overflow-x: scroll;
}

pre::-webkit-scrollbar {
  display: none;
}

pre {
  -ms-overflow-style: none;
  scrollbar-width: none;
}


.todo {
  color: var(--clr-todo);
  background: var(--bg-todo);
}

.done {
  color: var(--clr-done);
  background: var(--bg-done);
}

.timestamp-wrapper {
  font-size: 0.8rem;
  color: var(--clr-ts);
}

table {
  width: 100%;
  border: 2px solid var(--bc-tb);
}

thead {
  color: var(--clr-tb-hd);
  background: var(--bg-tb-hd);
}

td, th {
  border: thin solid var(--bc-tb);
}

li {
  line-height: 2rem;
}

a {
  text-decoration: none;
  color: var(--clr-link);
}

a:hover {
  text-decoration: underline;
}

#table-of-contents > h2 {
  display: none;
}

#table-of-contents {
  border: thin solid var(--bc-block);
  background: var(--bg-block);
}

#toggle-toc {
  display: none;
}

.toc-show {
  display: block!important;
}

@media only screen and (max-width: 768px) {
  #toggle-toc {
    position: fixed;
    top: 0;
    right: 0;
    cursor: pointer;
    padding-left: 10px;
    padding-right: 10px;
    font-size: 2em;
    line-height: 2em;
    display: block;
  }
  #table-of-contents {
    background: var(--bg);
    display: none;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    overflow-y: scroll;
  }
  #table-of-contents a {
    color: var(--clr);
  }
}

@media only screen and (min-width: 1024px) {
  #table-of-contents {
    font-size: 0.8rem;
    position: fixed;
    left: var(--mg);
    top: var(--mg);
    bottom: var(--mg);
    width: var(--w-toc);
    overflow-y: scroll;
  }
}

#table-of-contents::-webkit-scrollbar {
  display: none;
}

#table-of-contents {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.MathJax_Display {
  font-size: 1.25em;
}

#toggle-theme {
  border-width: 0;
  line-height: 4em;
  padding-left: 1em;
  padding-right: 1em;
  background: var(--bg-block);
  color: var(--clr-code);
}

#toggle-theme:hover {
  cursor: pointer;
}

img {
  width: 100%;
}

@media only screen and (max-width: 768px) {
  #toggle-theme {
    width: 100%;
    text-align: center;
  }
}

@media only screen and (min-width: 768px) {
  #toggle-theme {
    position: absolute;
    top: var(--mg);
    right: var(--mg);
    border-radius: 5px;
  }
}

.theme-transition {
  transition: all 0.5s;
}

.status {
  width: 100%;
}

@media only screen and (max-width: 768px) {
  ul {
    padding-left: .5em;
    margin-left: 0;
  }
  li {
    padding-left: 0;
    margin-left: 0;
  }
}
/*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<div id="toggle-theme">dark theme</div><div id="toggle-toc">&#9776;</div>
</div>
<div id="content">
<h1 class="title">Luca's nix configuration</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7b1aa29">1. Introduction</a>
<ul>
<li><a href="#org5464f9e">1.1. This repository</a></li>
<li><a href="#org8971291">1.2. This file</a></li>
</ul>
</li>
<li><a href="#org42fe3e8">2. flake.nix</a>
<ul>
<li><a href="#org0ec4586">2.1. file structure</a></li>
<li><a href="#orge335c1d">2.2. inputs</a></li>
<li><a href="#orge28ed17">2.3. nixpkgs config</a></li>
<li><a href="#org3bbffa7">2.4. home-manager config</a></li>
<li><a href="#org7bd1662">2.5. nix-darwin config</a></li>
<li><a href="#org369ab4f">2.6. luca-macbook-pro</a></li>
<li><a href="#org86658c4">2.7. github-ci</a></li>
<li><a href="#orgbce718d">2.8. home-manager-modules</a></li>
<li><a href="#org39cb4ec">2.9. cloud-vm</a></li>
<li><a href="#org5ef742e">2.10. dev-shell</a></li>
</ul>
</li>
<li><a href="#org82d5366">3. Practical commands</a>
<ul>
<li><a href="#orgb3842a0">3.1. Install nix (flakes)</a></li>
<li><a href="#org0ab1a4d">3.2. darwin-rebuild</a></li>
<li><a href="#orge5384e3">3.3. nix flake update</a></li>
</ul>
</li>
<li><a href="#orgc679e38">4. Nix</a>
<ul>
<li><a href="#orgbf96fed">4.1. Fundamentals</a></li>
<li><a href="#org4d1d332">4.2. Config</a></li>
<li><a href="#org0dbabd0">4.3. Derivation</a></li>
<li><a href="#org3b87f9f">4.4. Escaping in strings</a></li>
</ul>
</li>
<li><a href="#orga1939e8">5. References</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7b1aa29" class="outline-2">
<h2 id="org7b1aa29"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org5464f9e" class="outline-3">
<h3 id="org5464f9e"><span class="section-number-3">1.1</span> This repository</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This repository contains my system configuration.
The main objective is to have a portable and reproducible system in order to for example bootstrap a new system in a quick and automated way.
The ideal is to share packages and configuration across different operating systems.
At the moment I only use a <code>macOS</code> system but I am prepared for the day I will switch to <code>nixOS</code>
</p>

<p>
Tools:
</p>
<ul class="org-ul">
<li><code>nix</code> as a package manager
<ul class="org-ul">
<li>In particular, an experimental feature called <code>flake</code> to achieve complete reproducibility</li>
</ul></li>
<li><code>home-manager</code> to configure packages and dotfiles</li>
<li><code>nix-darwin</code> to configure macOS systems (e.g. it has a great <code>brew</code> module)</li>
</ul>
</div>
</div>

<div id="outline-container-org8971291" class="outline-3">
<h3 id="org8971291"><span class="section-number-3">1.2</span> This file</h3>
<div class="outline-text-3" id="text-1-2">
<p>
This file (<code>readme.org</code>) is used to generate (the correct term is <code>tangle</code>) my <code>flake.nix</code> file, where I specify the inputs and outputs of my system configuration.
The tangled <code>flake.nix</code> file imports other <code>.nix</code> files (e.g. <code>darwin/default.nix</code>).
</p>

<p>
This file is better viewed in HTML format <a href="https://luca.cambiaghi.me/nixpkgs/readme.html">here</a> or through <code>org-mode</code> (clone the repo and open in <code>emacs</code>).
You can visit my blog at the same <a href="https://luca.cambiaghi.me">website</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org42fe3e8" class="outline-2">
<h2 id="org42fe3e8"><span class="section-number-2">2</span> flake.nix</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org0ec4586" class="outline-3">
<h3 id="org0ec4586"><span class="section-number-3">2.1</span> file structure</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-nix"><span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">NOTE: this file is tangled from readme.org</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">DO NOT edit by hand</span>
{
  <span style="color: #00d3d0;">description</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"Luca Cambiaghi's darwin configuration"</span>;
  &lt;<span style="color: #00bcff;">&lt;inputs&gt;</span>&gt;
  <span style="color: #00d3d0;">outputs</span> = inputs@{ self, nixpkgs, darwin, home-manager, flake-utils, ... }:
    <span style="color: #b6a0ff; font-weight: bold;">let</span>
      &lt;<span style="color: #00bcff;">&lt;nixpkgs-config&gt;</span>&gt;
      &lt;<span style="color: #00bcff;">&lt;home-manager-config&gt;</span>&gt;
      &lt;<span style="color: #00bcff;">&lt;nix-darwin-config&gt;</span>&gt;
    <span style="color: #b6a0ff; font-weight: bold;">in</span> {
      <span style="color: #00d3d0;">darwinConfigurations</span> = {
        &lt;<span style="color: #00bcff;">&lt;luca-macbookpro&gt;</span>&gt;
        &lt;<span style="color: #00bcff;">&lt;github-ci&gt;</span>&gt;
      };
      &lt;<span style="color: #00bcff;">&lt;cloud-vm&gt;</span>&gt;
      &lt;<span style="color: #00bcff;">&lt;home-manager-modules&gt;</span>&gt;
    } //
    &lt;<span style="color: #00bcff;">&lt;dev-shell&gt;</span>&gt;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge335c1d" class="outline-3">
<h3 id="orge335c1d"><span class="section-number-3">2.2</span> inputs</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-nix" id="orgde51abc"><span style="color: #00d3d0;">inputs</span> = {
  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># Package sets</span>
  <span style="color: #00d3d0;">nixpkgs.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:nixos/nixpkgs/nixpkgs-unstable"</span>;
  <span style="color: #00d3d0;">nixpkgs-master.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:nixos/nixpkgs/master"</span>;
  <span style="color: #00d3d0;">nixpkgs-stable-darwin.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:nixos/nixpkgs/nixpkgs-20.09-darwin"</span>;
  <span style="color: #00d3d0;">nixos-stable.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:nixos/nixpkgs/nixos-20.09"</span>;

  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># Environment/system management</span>
  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># darwin.url = "github:lnl7/nix-darwin";</span>
  <span style="color: #00d3d0;">darwin.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:hardselius/nix-darwin"</span>;
  <span style="color: #00d3d0;">darwin.inputs.nixpkgs.follows</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"nixpkgs"</span>;
  <span style="color: #00d3d0;">home-manager.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:nix-community/home-manager"</span>;
  <span style="color: #00d3d0;">home-manager.inputs.nixpkgs.follows</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"nixpkgs"</span>;

  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># Other sources</span>
  <span style="color: #00d3d0;">emacs.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:nix-community/emacs-overlay"</span>;
  <span style="color: #00d3d0;">fish-done</span> = { <span style="color: #00d3d0;">url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:franciscolourenco/done"</span>; <span style="color: #00d3d0;">flake</span> = <span style="color: #f78fe7; font-weight: bold;">false</span>; };
  <span style="color: #00d3d0;">flake-compat</span> = { <span style="color: #00d3d0;">url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:edolstra/flake-compat"</span>; <span style="color: #00d3d0;">flake</span> = <span style="color: #f78fe7; font-weight: bold;">false</span>; };
  <span style="color: #00d3d0;">flake-utils.url</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"github:numtide/flake-utils"</span>;
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orge28ed17" class="outline-3">
<h3 id="orge28ed17"><span class="section-number-3">2.3</span> nixpkgs config</h3>
<div class="outline-text-3" id="text-2-3">
<p>
The trick in the <code>overlays</code> variable allows us to use the stable version of problematic
packages. You can just use <code>stable.pkg</code> instead of <code>pkg</code> in <code>home/default.nix</code>
</p>

<div class="org-src-container">
<pre class="src src-nix" id="org773fbbd"><span style="color: #00d3d0;">nixpkgsConfig</span> = <span style="color: #b6a0ff; font-weight: bold;">with</span> inputs; {
  <span style="color: #00d3d0;">config</span> = {
    <span style="color: #00d3d0;">allowUnfree</span> = <span style="color: #f78fe7; font-weight: bold;">true</span>;
    <span style="color: #00d3d0;">allowUnsupportedSystem</span> = <span style="color: #f78fe7; font-weight: bold;">true</span>;
  };
  <span style="color: #00d3d0;">overlays</span> = [
    (
      final: prev:
      <span style="color: #b6a0ff; font-weight: bold;">let</span>
        <span style="color: #00d3d0;">system</span> = prev.stdenv.system;
        <span style="color: #00d3d0;">nixpkgs-stable</span> = <span style="color: #b6a0ff; font-weight: bold;">if</span> system == <span style="color: var(--clr-string); background-color: var(--bg-string);">"x86_64-darwin"</span> <span style="color: #b6a0ff; font-weight: bold;">then</span> nixpkgs-stable-darwin <span style="color: #b6a0ff; font-weight: bold;">else</span> nixos-stable;
      <span style="color: #b6a0ff; font-weight: bold;">in</span> {
        <span style="color: #00d3d0;">master</span> = nixpkgs-master.legacyPackages.${system};
        <span style="color: #00d3d0;">stable</span> = nixpkgs-stable.legacyPackages.${system};
      }
    )
    emacs.overlay
  ];
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org3bbffa7" class="outline-3">
<h3 id="org3bbffa7"><span class="section-number-3">2.4</span> home-manager config</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-nix" id="org84f1f5b"><span style="color: #00d3d0;">homeManagerCommonConfig</span> = <span style="color: #b6a0ff; font-weight: bold;">with</span> self.homeManagerModules; {
  <span style="color: #00d3d0;">imports</span> = [
    <span style="color: #00bcff;">./home</span>
    <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># configs.git.aliases</span>
    <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># configs.starship.symbols</span>
    <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># programs.kitty.extras</span>
  ];
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org7bd1662" class="outline-3">
<h3 id="org7bd1662"><span class="section-number-3">2.5</span> nix-darwin config</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-nix" id="orgba6bc00"><span style="color: #00d3d0;">nixDarwinCommonModules</span> = { user }: [
  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># Main `nix-darwin` config</span>
  <span style="color: #00bcff;">./darwin</span>
  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># `home-manager` module</span>
  home-manager.darwinModules.home-manager
  {
    <span style="color: #00d3d0;">nixpkgs</span> = nixpkgsConfig;
    <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># Hack to support legacy worklows that use `&lt;nixpkgs&gt;` etc.</span>
    <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># nix.nixPath = { nixpkgs = "$HOME/.config/nixpkgs/nixpkgs.nix"; };</span>
    <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># `home-manager` config</span>
    users.users.${user}.<span style="color: #00d3d0;">home</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"/Users/</span><span style="color: #ff9977;">${</span>user<span style="color: #ff9977;">}</span>";
    <span style="color: #00d3d0;">home-manager.useGlobalPkgs</span> = <span style="color: #f78fe7; font-weight: bold;">true</span>;
    home-manager.users.${user} = homeManagerCommonConfig;
  }
];
</pre>
</div>
</div>
</div>

<div id="outline-container-org369ab4f" class="outline-3">
<h3 id="org369ab4f"><span class="section-number-3">2.6</span> luca-macbook-pro</h3>
<div class="outline-text-3" id="text-2-6">
<div class="org-src-container">
<pre class="src src-nix" id="orgfe971cd"><span style="color: #00d3d0;">luca-macbookpro</span> = darwin.lib.darwinSystem {
  <span style="color: #00d3d0;">modules</span> = nixDarwinCommonModules { <span style="color: #00d3d0;">user</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"luca"</span>; } ++ [
    {
      <span style="color: #00d3d0;">networking</span> = {
        <span style="color: #00d3d0;">knownNetworkServices</span> = [<span style="color: var(--clr-string); background-color: var(--bg-string);">"Wi-Fi"</span> <span style="color: var(--clr-string); background-color: var(--bg-string);">"Bluetooth PAN"</span> <span style="color: var(--clr-string); background-color: var(--bg-string);">"Thunderbolt Bridge"</span>];
        <span style="color: #00d3d0;">hostName</span> =  <span style="color: var(--clr-string); background-color: var(--bg-string);">"luca-macbookpro"</span>;
        <span style="color: #00d3d0;">computerName</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"luca-macbookpro"</span>;
        <span style="color: #00d3d0;">localHostName</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"luca-macbookpro"</span>;
      };
    }
  ];
  <span style="color: #00d3d0;">specialArgs</span> = { <span style="color: #b6a0ff; font-weight: bold;">inherit</span> inputs nixpkgs; };
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org86658c4" class="outline-3">
<h3 id="org86658c4"><span class="section-number-3">2.7</span> github-ci</h3>
<div class="outline-text-3" id="text-2-7">
<div class="org-src-container">
<pre class="src src-nix" id="orga3a069f"><span style="color: #00d3d0;">githubCI</span> = darwin.lib.darwinSystem {
  <span style="color: #00d3d0;">modules</span> = nixDarwinCommonModules { <span style="color: #00d3d0;">user</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"runner"</span>; } ++ [
    ({ lib, ... }: { <span style="color: #00d3d0;">homebrew.enable</span> = lib.mkForce <span style="color: #f78fe7; font-weight: bold;">false</span>; })
  ];
};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbce718d" class="outline-3">
<h3 id="orgbce718d"><span class="section-number-3">2.8</span> home-manager-modules</h3>
<div class="outline-text-3" id="text-2-8">
<div class="org-src-container">
<pre class="src src-nix" id="org7a22f67"><span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">homeManagerModules = {</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);">#   </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">configs.git.aliases = import ./home/configs/git-aliases.nix;</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);">#   </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">configs.gh.aliases = import ./home/configs/gh-aliases.nix;</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);">#   </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">configs.starship.symbols = import ./home/configs/starship-symbols.nix;</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);">#   </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">programs.neovim.extras = import ./home/modules/programs/neovim/extras.nix;</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);">#   </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">programs.kitty.extras = import ./home/modules/programs/kitty/extras.nix;</span>
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">};</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org39cb4ec" class="outline-3">
<h3 id="org39cb4ec"><span class="section-number-3">2.9</span> cloud-vm</h3>
<div class="outline-text-3" id="text-2-9">
<p>
Build and activate with <code>nix build .#cloudVM.activationPackage; ./result/activate</code>
</p>
<div class="org-src-container">
<pre class="src src-nix" id="org9e0e4ac"><span style="color: #00d3d0;">cloudVM</span> = home-manager.lib.homeManagerConfiguration {
  <span style="color: #00d3d0;">system</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"x86_64-linux"</span>;
  <span style="color: #00d3d0;">homeDirectory</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"/home/luca"</span>;
  <span style="color: #00d3d0;">username</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"luca"</span>;
  <span style="color: #00d3d0;">configuration</span> = {
    <span style="color: #00d3d0;">imports</span> = [ homeManagerCommonConfig ];
    <span style="color: #00d3d0;">nixpkgs</span> = nixpkgsConfig;
  };
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ef742e" class="outline-3">
<h3 id="org5ef742e"><span class="section-number-3">2.10</span> dev-shell</h3>
<div class="outline-text-3" id="text-2-10">
<div class="org-src-container">
<pre class="src src-nix" id="org458b725">inputs.flake-utils.lib.eachDefaultSystem (system:
  <span style="color: #b6a0ff; font-weight: bold;">let</span>
    <span style="color: #00d3d0;">pkgs</span> = nixpkgs.legacyPackages.${system};
  <span style="color: #b6a0ff; font-weight: bold;">in</span> {
    <span style="color: #00d3d0;">devShell</span> = <span style="color: #f78fe7; font-weight: bold;">import</span> <span style="color: #00bcff;">./shell.nix</span> { <span style="color: #b6a0ff; font-weight: bold;">inherit</span> pkgs; };
  });
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org82d5366" class="outline-2">
<h2 id="org82d5366"><span class="section-number-2">3</span> Practical commands</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgb3842a0" class="outline-3">
<h3 id="orgb3842a0"><span class="section-number-3">3.1</span> Install nix (flakes)</h3>
<div class="outline-text-3" id="text-3-1">
<p>
thanks <a href="https://github.com/kclejeune/system">https://github.com/kclejeune/system</a>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">1.</span>
<span style="color: var(--clr-keyword); background-color: var(--bg-keyword);">if</span> [[ $(uname -s) == <span style="color: var(--clr-string); background-color: var(--bg-string);">'Darwin'</span> ]]; <span style="color: var(--clr-keyword); background-color: var(--bg-keyword);">then</span>
    <span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">sh &lt;(curl -L https://nixos.org/nix/install) --daemon --darwin-use-unencrypted-nix-store-volume</span>
    sh &lt;(curl -L https://github.com/numtide/nix-flakes-installer/releases/download/nix-2.4pre20210126_f15f0b8/install) --daemon --darwin-use-unencrypted-nix-store-volume
<span style="color: var(--clr-keyword); background-color: var(--bg-keyword);">else</span>
    sh &lt;(curl -L https://nixos.org/nix/install) --daemon
<span style="color: var(--clr-keyword); background-color: var(--bg-keyword);">fi</span>

<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">2.</span>
git clone git@github.com:lccambiaghi/nixpkgs.git ~/git/nixpkgs

<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">3.</span>
<span style="color: var(--clr-builtin); background-color: var(--bg-builtin);">cd</span> ~/git/nixpkgs &amp;&amp; nix build <span style="color: var(--clr-string); background-color: var(--bg-string);">".#darwinConfigurations.luca-macbookpro.system"</span> &amp;&amp; ./result/sw/bin/darwin-rebuild switch --flake .#luca-macbookpro
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ab1a4d" class="outline-3">
<h3 id="org0ab1a4d"><span class="section-number-3">3.2</span> darwin-rebuild</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-sh">darwin-rebuild build --flake .#luca-macbookpro
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">nix build ".#darwinConfigurations.luca-macbookpro.system"</span>
darwin-rebuild switch --flake .#luca-macbookpro
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">./result/sw/bin/darwin-rebuild switch --flake .#luca-macbookpro</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5384e3" class="outline-3">
<h3 id="orge5384e3"><span class="section-number-3">3.3</span> nix flake update</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-sh">nix flake update --update-input nixpkgs
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc679e38" class="outline-2">
<h2 id="orgc679e38"><span class="section-number-2">4</span> Nix</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Good intro: <a href="https://stephank.nl/p/2020-06-01-a-nix-primer-by-a-newcomer.html">https://stephank.nl/p/2020-06-01-a-nix-primer-by-a-newcomer.html</a></li>
</ul>
</div>

<div id="outline-container-orgbf96fed" class="outline-3">
<h3 id="orgbf96fed"><span class="section-number-3">4.1</span> Fundamentals</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Set:
</p>
<div class="org-src-container">
<pre class="src src-nix">{ <span style="color: var(--clr-string); background-color: var(--bg-string);">"a b"</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"c"</span>; <span style="color: #00d3d0;">count</span> = 2; }
</pre>
</div>

<p>
List:
</p>
<div class="org-src-container">
<pre class="src src-nix">[42 <span style="color: var(--clr-string); background-color: var(--bg-string);">"a b"</span> (3 + 6) [2 3 4] {<span style="color: #00d3d0;">x</span> = 2;}]
</pre>
</div>

<p>
Lambda:
</p>
<div class="org-src-container">
<pre class="src src-nix">(x: x + x) 21
<span style="color: var(--clr-comment-delimiter); background-color: var(--bg-comment-delimiter);"># </span><span style="color: var(--clr-comment); background-color: var(--bg-comment);">42</span>

<span style="color: #b6a0ff; font-weight: bold;">let</span> <span style="color: #00d3d0;">hi</span> = {name, place}: <span style="color: var(--clr-string); background-color: var(--bg-string);">"Hi </span><span style="color: #ff9977;">${</span>name<span style="color: #ff9977;">}</span><span style="color: var(--clr-string); background-color: var(--bg-string);"> in </span><span style="color: #ff9977;">${</span>place<span style="color: #ff9977;">}</span><span style="color: var(--clr-string); background-color: var(--bg-string);">!"</span>;
<span style="color: #b6a0ff; font-weight: bold;">in</span> hi { <span style="color: #00d3d0;">name</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"Michael"</span>; <span style="color: #00d3d0;">place</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"Austria"</span>;  }
</pre>
</div>

<p>
Parameter with default value:
</p>
<div class="org-src-container">
<pre class="src src-nix">{ pkgs ? <span style="color: #f78fe7; font-weight: bold;">import</span> <span style="color: #00bcff;">&lt;nixpkgs&gt;</span> {} }:
</pre>
</div>

<p>
<code>&lt;nixpkgs&gt;</code> refers to the value of the nixpkgs attribute declared in the NIX<sub>PATH</sub> environment variable
</p>
</div>
</div>

<div id="outline-container-org4d1d332" class="outline-3">
<h3 id="org4d1d332"><span class="section-number-3">4.2</span> Config</h3>
<div class="outline-text-3" id="text-4-2">
<p>
A config takes an attribute as parameter and returns an attribute set
</p>
<div class="org-src-container">
<pre class="src src-nix">{ pkgs }:

{
  <span style="color: #00d3d0;">packageOverrides</span> = pkgs: {
    <span style="color: #00d3d0;">emacs</span> = pkgs.emacs.override {
      <span style="color: #00d3d0;">withGTK2</span> = <span style="color: #f78fe7; font-weight: bold;">false</span>;
      <span style="color: #00d3d0;">withGTK3</span> = <span style="color: #f78fe7; font-weight: bold;">false</span>;
      <span style="color: #00d3d0;">withXwidgets</span> = <span style="color: #f78fe7; font-weight: bold;">false</span>;
    };
  };

  <span style="color: #00d3d0;">allowUnfree</span> = <span style="color: #f78fe7; font-weight: bold;">true</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org0dbabd0" class="outline-3">
<h3 id="org0dbabd0"><span class="section-number-3">4.3</span> Derivation</h3>
<div class="outline-text-3" id="text-4-3">
<p>
A derivation takes inputs and produces output.
A derivation is lazy, so it will only be evaluated when it is input to other derivations.
</p>

<div class="org-src-container">
<pre class="src src-nix"><span style="color: #f78fe7; font-weight: bold;">derivation</span> {
  <span style="color: #00d3d0;">name</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"hello-world"</span>;
  <span style="color: #00d3d0;">system</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"x86_64-linux"</span>;
  <span style="color: #00d3d0;">outputs</span> = [ <span style="color: var(--clr-string); background-color: var(--bg-string);">"out"</span> ];  <span style="color: var(--clr-comment); background-color: var(--bg-comment);"># This is the default, and can be omitted.</span>
  <span style="color: #00d3d0;">builder</span> = <span style="color: var(--clr-string); background-color: var(--bg-string);">"</span><span style="color: #ff9977;">${</span>pkgs.bash<span style="color: #ff9977;">}</span><span style="color: var(--clr-string); background-color: var(--bg-string);">/bin/bash"</span>;
  <span style="color: #00d3d0;">args</span> = [ <span style="color: var(--clr-string); background-color: var(--bg-string);">"-c"</span> <span style="color: var(--clr-string); background-color: var(--bg-string);">"echo 'Hello world!' &gt; $out"</span> ];
}
</pre>
</div>

<p>
Derviation outputs are stored in the nix store.
Each derivation's output is defined by an hash which encodes all input derivations.
If something changes even slightly in the inputs, the hash output will change.
</p>
</div>
</div>
<div id="outline-container-org3b87f9f" class="outline-3">
<h3 id="org3b87f9f"><span class="section-number-3">4.4</span> Escaping in strings</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>You can use <code>'</code> to escape double quotes</li>
<li>You can use <code>''</code> to escape dollar</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga1939e8" class="outline-2">
<h2 id="orga1939e8"><span class="section-number-2">5</span> References</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li><a href="https://github.com/malob/nixpkgs">https://github.com/malob/nixpkgs</a></li>
<li><a href="https://github.com/kclejeune/system">https://github.com/kclejeune/system</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
let cookie = document.cookie.split('; ').find(r => r.startsWith('org_html_themify_theme'))
let theme = 'light'

if (cookie) {
  theme = cookie.split('=')[1]
}

let toggleThemeBtn = document.getElementById('toggle-theme')
let toggleTocBtn = document.getElementById('toggle-toc')

if (theme == 'light') {
  useLightTheme();
} else {
  useDarkTheme();
}

function transition() {
  document.body.classList.add('theme-transition')
  setTimeout(() => document.body.classList.remove('theme-transition'), 500)
}

function useLightTheme(theme) {
  document.body.dataset.theme = 'light'
  toggleThemeBtn.innerHTML = 'dark theme'
  document.cookie = 'org_html_themify_theme=light'
}

function useDarkTheme(theme) {
  document.body.dataset.theme = 'dark'
  toggleThemeBtn.innerHTML = 'light theme'
  document.cookie = 'org_html_themify_theme=dark'
}

toggleThemeBtn.addEventListener('click', function() {
  transition()
  if (document.body.dataset.theme == 'light') {
    useDarkTheme();
  } else {
    useLightTheme();
  }
})


let toc = document.getElementById('table-of-contents')

toggleTocBtn.addEventListener('click', function() {
  toc.classList.add('toc-show')
  toc.addEventListener('click', function() {
    toc.classList.remove('toc-show')
  })
})
/*]]>*/-->
</script>
</div>
</body>
</html>
